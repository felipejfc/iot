#
# Copyright (c) 2020 Nordic Semiconductor ASA
#
# SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
#

# ==============================================================================
# LOW POWER CONFIGURATION FOR BATTERY OPERATION
# ==============================================================================
# This configuration disables USB and console for true low-power operation.
#
# To build with this configuration:
#   west build -b promicro_nrf52840/nrf52840/uf2 -- -DCONF_FILE=prj_lp.conf
#
# Expected power consumption in sleepy mode: <10µA average
# (Hold button during boot to enable sleepy mode with 5-minute keep-alive)
#
# NOTE: No debug output available - device runs "headless"
# Use prj.conf for development builds with USB console
# ==============================================================================

CONFIG_NCS_SAMPLES_DEFAULTS=y

CONFIG_GPIO=y

CONFIG_HEAP_MEM_POOL_SIZE=2048

CONFIG_ZIGBEE=y
CONFIG_ZIGBEE_APP_UTILS=y
CONFIG_ZIGBEE_ROLE_END_DEVICE=y

# Enable nRF ECB driver for Zigbee crypto
CONFIG_CRYPTO=y
CONFIG_CRYPTO_NRF_ECB=y
CONFIG_CRYPTO_INIT_PRIORITY=80
CONFIG_FLASH_MAP=y
CONFIG_MPU_ALLOW_FLASH_WRITE=y
CONFIG_FLASH=y

# This example requires more workqueue stack
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2048

# Enable API for powering down unused RAM parts
CONFIG_RAM_POWER_DOWN_LIBRARY=y

# Networking
CONFIG_NET_IPV6=n
CONFIG_NET_IP_ADDR_CHECK=n
CONFIG_NET_UDP=n

# ==============================================================================
# USB/CONSOLE DISABLED FOR LOW POWER
# ==============================================================================
# All USB and console features are disabled to allow deep sleep
# The device will consume <10µA in sleepy mode with these settings

# Disable UART (not needed without console)
CONFIG_UART_INTERRUPT_DRIVEN=n
CONFIG_SERIAL=n

# Disable console output
CONFIG_CONSOLE=n
CONFIG_UART_CONSOLE=n
CONFIG_PRINTK=n
# Disable boot banners (they select PRINTK/EARLY_CONSOLE)
CONFIG_NCS_BOOT_BANNER=n
CONFIG_BOOT_BANNER=n
CONFIG_EARLY_CONSOLE=n

# Disable assertions/debug validation (can force PRINTK and add overhead)
CONFIG_ASSERT=n
CONFIG_SPIN_VALIDATE=n

# Disable USB stack completely
CONFIG_USB_DEVICE_STACK=n
# CONFIG_USB_DEVICE_REMOTE_WAKEUP is not set
# CONFIG_USB_DEVICE_PRODUCT is not set
# CONFIG_USB_CDC_ACM is not set
# CONFIG_UART_LINE_CTRL is not set
# CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT is not set

# ==============================================================================
# POWER MANAGEMENT FOR DEEP SLEEP
# ==============================================================================

# Enable system clock (required for power management)
CONFIG_SYS_CLOCK_EXISTS=y

CONFIG_PM=y

CONFIG_POWEROFF=y

# Enable Power Management subsystem - CRITICAL for sleep
CONFIG_PM_DEVICE=y

# Enable tickless kernel - allows system to sleep between events
CONFIG_TICKLESS_KERNEL=y

# Reduce idle stack size to save RAM
CONFIG_IDLE_STACK_SIZE=512

# Disable logging subsystem completely
CONFIG_LOG=n

# Disable shell
CONFIG_SHELL=n

# ==============================================================================
# ADDITIONAL POWER SAVINGS
# ==============================================================================

# Disable unused peripherals to reduce power
CONFIG_I2C=n
CONFIG_SPI=n

# Optimize for size (smaller code = less power during execution)
CONFIG_SPEED_OPTIMIZATIONS=n
CONFIG_SIZE_OPTIMIZATIONS=y

# Reduce system workqueue priority to allow better sleep
CONFIG_SYSTEM_WORKQUEUE_PRIORITY=-1

# ==============================================================================
# CRITICAL: NORDIC POWER MANAGEMENT
# ==============================================================================
# Nordic-specific power management for nRF52840

# Enable Nordic PM (nrfx power management driver)
CONFIG_NRFX_POWER=y

# DCDC converter is typically enabled by default on nRF52840 boards
# If your board doesn't have DCDC, the above won't hurt

CONFIG_ZIGBEE_CHANNEL=25

CONFIG_ZIGBEE_CHANNEL_SELECTION_MODE_SINGLE=y

# ADC for voltage sensing
CONFIG_ADC=y
CONFIG_ADC_READING_INTERVAL_SEC=60
